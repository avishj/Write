name: Lighthouse Audit

on:
  workflow_call:
    inputs:
      url:
        description: URL to audit
        type: string
        required: false
        default: https://count.avishj.dev
      local-server:
        description: Start local test server before auditing
        type: boolean
        required: false
        default: false
      wait-seconds:
        description: Seconds to wait before auditing (e.g. deployment propagation)
        type: number
        required: false
        default: 0

jobs:
  audit:
    name: Audit (${{ matrix.profile }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        profile: [mobile, tablet, desktop]

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup JS environment
        if: inputs.local-server
        uses: ./.github/actions/setup-js

      - name: Start test server
        if: inputs.local-server
        run: |
          bun run build
          bun run preview -- --host 0.0.0.0 --port 4321 &
          for _ in $(seq 1 10); do
            curl -s http://localhost:4321 > /dev/null && exit 0
            sleep 1
          done
          echo "::error::Test server failed to start on localhost:4321"
          exit 1

      - name: Wait for propagation
        if: inputs.wait-seconds > 0
        run: sleep ${{ inputs.wait-seconds }}

      - name: Run AutoLighthouse
        uses: avishj/AutoLighthouse@main
        with:
          mode: audit
          urls: ${{ inputs.url }}
          profile: ${{ matrix.profile }}
          preset: strict

  report:
    name: Report
    needs: audit
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run AutoLighthouse Report
        uses: avishj/AutoLighthouse@main
        with:
          mode: report
